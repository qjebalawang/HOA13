---
# Network Time Protocol (NTP)
- name: Install Chrony
  apt:
    name: chrony
    state: present

- name: Configure Chrony
  blockinfile:
    path: /etc/chrony/chrony.conf
    marker: "# {mark} Ansible managed block"
    block: |
      # Use the controller as the NTP server
      server NTP_SERVER iburst

      # Allow connections from the specified network
      allow 10.0.0.0/24

  notify: Restart Chrony

- name: Restart Chrony
  service:
    name: chrony
    state: restarted

- name: Display Chrony Sources
  command: chronyc sources

# OpenStack Packages
- name: Add OpenStack Bobcat repository
  apt_repository:
    repo: 'deb http://archive.ubuntu.com/ubuntu/ focal-updates main'
    state: present
    filename: 'cloud-archive-bobcat'

- name: Add OpenStack Antelope repository
  apt_repository:
    repo: 'deb http://archive.ubuntu.com/ubuntu/ focal-updates main'
    state: present
    filename: 'cloud-archive-antelope'

- name: Add OpenStack Zed repository
  apt_repository:
    repo: 'deb http://archive.ubuntu.com/ubuntu/ focal-updates main'
    state: present
    filename: 'cloud-archive-zed'

- name: Add OpenStack Yoga repository
  apt_repository:
    repo: 'deb http://archive.ubuntu.com/ubuntu/ focal-updates main'
    state: present
    filename: 'cloud-archive-yoga'


- name: Install Nova Compute
  apt:
    name: nova-compute
    state: present

- name: Install OpenStack Client
  apt:
    name: python3-openstackclient
    state: present

# SQL Database
- name: Install MariaDB server and Python3 PyMySQL
  apt:
    name:
      - mariadb-server
      - python3-pymysql
    state: present

- name: Ensure the directory exists
  file:
    path: /etc/mysql/mariadb.conf.d/
    state: directory

- name: Add OpenStack MariaDB configuration file
  blockinfile:
    path: /etc/mysql/mariadb.conf.d/99-openstack.cnf
    block: |
      [mysqld]
      bind-address = 10.0.0.11
      default-storage-engine = innodb
      innodb_file_per_table = on
      max_connections = 4096
      collation-server = utf8_general_ci
      character-set-server = utf8

- name: Restart MariaDB service
  service:
    name: mysql
    state: restarted

- name: Secure the MariaDB service
  command: mysql_secure_installation

# Message Queue
- name: Install RabbitMQ server
  apt:
    name: rabbitmq-server
    state: present

- name: Add OpenStack user to RabbitMQ
  command: rabbitmqctl add_user openstack RABBIT_PASS
  args:
    creates: "/var/lib/rabbitmq/.erlang.cookie"
  vars:
    RABBIT_PASS: rabbitmq_password

- name: Set permissions for OpenStack user in RabbitMQ
  command: rabbitmqctl set_permissions openstack ".*" ".*" ".*"

  vars:
    rabbitmq_password: 1234

# Memcached
- name: Install Memcached and Python3 Memcache
  apt:
    name:
      - memcached
      - python3-memcache
    state: present

- name: Edit Memcached configuration file
  lineinfile:
    path: /etc/memcached.conf
    line: '-l 10.0.0.11'
    backup: yes
  notify: Restart Memcached

- name: Restart Memcached
  service:
    name: memcached
    state: restarted

# Etcd
- name: Install Etcd
  apt:
    name: etcd
    state: present

- name: Edit Etcd configuration file
  lineinfile:
    path: /etc/default/etcd
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
  loop:
    - { regexp: '^ETCD_NAME=', line: 'ETCD_NAME="controller"' }
    - { regexp: '^ETCD_DATA_DIR=', line: 'ETCD_DATA_DIR="/var/lib/etcd"' }
    - { regexp: '^ETCD_INITIAL_CLUSTER_STATE=', line: 'ETCD_INITIAL_CLUSTER_STATE="new"' }
    - { regexp: '^ETCD_INITIAL_CLUSTER_TOKEN=', line: 'ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-01"' }
    - { regexp: '^ETCD_INITIAL_CLUSTER=', line: 'ETCD_INITIAL_CLUSTER="controller=http://10.0.0.11:2380"' }
    - { regexp: '^ETCD_INITIAL_ADVERTISE_PEER_URLS=', line: 'ETCD_INITIAL_ADVERTISE_PEER_URLS="http://10.0.0.11:2380"' }
    - { regexp: '^ETCD_ADVERTISE_CLIENT_URLS=', line: 'ETCD_ADVERTISE_CLIENT_URLS="http://10.0.0.11:2379"' }
    - { regexp: '^ETCD_LISTEN_PEER_URLS=', line: 'ETCD_LISTEN_PEER_URLS="http://0.0.0.0:2380"' }
    - { regexp: '^ETCD_LISTEN_CLIENT_URLS=', line: 'ETCD_LISTEN_CLIENT_URLS="http://10.0.0.11:2379"' }

- name: Enable and restart Etcd service
  systemd:
    name: etcd
    enabled: yes
    state: restarted
