---
# Network Time Protocol (NTP)
- name: Install Chrony
  yum:
    name: chrony
    state: present

- name: Configure Chrony
  blockinfile:
    path: "/etc/chrony.conf"
    marker: "# {mark} Ansible managed section"
    insertbefore: EOF
    block: |
      # Allow NTP client access from local network
      allow 192.168.1.0/24

      # Reference the controller node for clock synchronization
      server controller iburst

      # Comment out or remove other server keys
      # server other_server iburst

      # Comment out the pool line
      # pool 2.debian.pool.ntp.org offline iburst
  notify: Restart Chrony

- name: Enable and Start Chrony Service
  systemd:
    name: chronyd
    enabled: yes
    state: started
  notify: Restart Chrony

- name: Restart Chrony
  service:
    name: chronyd
    state: restarted

# OpenStack Packages
- name: Install required packages
  yum:
    name: 
      - epel-release
      - centos-release-openstack-stein
    state: present

- name: Install OpenStack packages
  yum:
    name:
      - openstack-packagename1
      - openstack-packagename2
    state: present

- name: Enable and start services
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
  loop:
    - openstack-service1
    - openstack-service2

- name: Set SELinux to permissive mode (optional, adjust as needed)
  selinux:
    policy: targeted
    state: permissive

# SQL Database
- name: Install MariaDB and related packages
  yum:
    name:
      - mariadb
      - mariadb-server
      - python2-PyMySQL
    state: present

- name: Create and edit openstack.cnf
  blockinfile:
    path: "/etc/my.cnf.d/openstack.cnf"
    create: yes
    block: |
      [mysqld]
      bind-address = 10.0.0.11
      default-storage-engine = innodb
      innodb_file_per_table = on
      max_connections = 4096
      collation-server = utf8_general_ci
      character-set-server = utf8

- name: Start MariaDB service and enable it on boot
  systemd:
    name: mariadb
    state: started
    enabled: yes

- name: Secure the MariaDB service
  command: "mysql_secure_installation"
  async: 9999
  poll: 0
  ignore_errors: yes

# Message Queue
- name: Install RabbitMQ server
  yum:
    name: rabbitmq-server
    state: present

- name: Start RabbitMQ service and enable it on boot
  systemd:
    name: rabbitmq-server
    state: started
    enabled: yes

- name: Add openstack user to RabbitMQ
  command: "rabbitmqctl add_user openstack RABBIT_PASS"
  vars:
    RABBIT_PASS: "1234"

- name: Set permissions for openstack user in RabbitMQ
  command: "rabbitmqctl set_permissions openstack '.*' '.*' '.*'"

# Memcached
- name: Install Memcached and Python bindings
  yum:
    name:
      - memcached
      - python-memcached
    state: present

- name: Configure Memcached
  blockinfile:
    path: "/etc/sysconfig/memcached"
    create: yes
    block: |
      OPTIONS="-l 127.0.0.1,::1,controller"

- name: Start Memcached service and enable it on boot
  systemd:
    name: memcached
    state: started
    enabled: yes

# Etcd
- name: Install Etcd
  yum:
    name: etcd
    state: present

- name: Configure Etcd
  blockinfile:
    path: "/etc/etcd/etcd.conf"
    create: yes
    block: |
      #[Member]
      ETCD_DATA_DIR="/var/lib/etcd/default.etcd"
      ETCD_LISTEN_PEER_URLS="http://10.0.0.11:2380"
      ETCD_LISTEN_CLIENT_URLS="http://10.0.0.11:2379"
      ETCD_NAME="controller"
      #[Clustering]
      ETCD_INITIAL_ADVERTISE_PEER_URLS="http://10.0.0.11:2380"
      ETCD_ADVERTISE_CLIENT_URLS="http://10.0.0.11:2379"
      ETCD_INITIAL_CLUSTER="controller=http://10.0.0.11:2380"
      ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster-01"
      ETCD_INITIAL_CLUSTER_STATE="new"

- name: Enable and start Etcd service
  systemd:
    name: etcd
    enabled: yes
    state: started
